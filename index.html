<script>
    const API_URL = "https://gpt-backend-kodi.onrender.com/chat"; 
    const HISTORY_URL = "https://gpt-backend-kodi.onrender.com/history";
    const ADMIN_CODE = "Admin123"; 

    // *** NOUVELLE LOGIQUE : GESTION DE L'ID UTILISATEUR ***
    function getUserId() {
        let userId = localStorage.getItem('chatUserId');
        if (!userId) {
            // Créer un ID unique simple
            userId = 'user-' + Date.now() + Math.floor(Math.random() * 9999);
            localStorage.setItem('chatUserId', userId);
        }
        return userId;
    }
    const currentUserId = getUserId(); 
    console.log("UserID pour cette session:", currentUserId);


    async function sendMessage() {
        // *** CORRECTION CRITIQUE : DÉCLARATION DES VARIABLES DOM ***
        const input = document.getElementById("input");
        const sendButton = document.getElementById("send-button");
        const messagesDiv = document.getElementById("messages"); 
        
        const message = input.value.trim();
        if (message === "") return;

        // Désactiver l'input et le bouton pendant le traitement
        sendButton.disabled = true;
        input.disabled = true;

        // 1. Afficher le message de l'utilisateur
        messagesDiv.innerHTML += 
            `<div class="message-line user">Utilisateur : ${message}</div>`;

        input.value = ""; 

        // Afficher un indicateur de chargement
        messagesDiv.innerHTML += 
            `<div id="loading" class="message-line bot">Bot : ... (réponse en cours)</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;


        try {
            const response = await fetch(
                API_URL,
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ 
                        message: message,
                        // ENVOYER L'ID UTILISATEUR AU BACKEND
                        userId: currentUserId 
                    })
                }
            );

            // Retirer l'indicateur de chargement
            const loadingDiv = document.getElementById("loading");
            if (loadingDiv) loadingDiv.remove();

            const data = await response.json();

            if (response.ok) {
                messagesDiv.innerHTML +=
                    `<div class="message-line bot">Bot : ${data.reply}</div>`;
            } else {
                 messagesDiv.innerHTML +=
                    `<div class="message-line error">Erreur du serveur (${response.status}) : ${data.reply || 'Problème de connexion.'}</div>`;
            }


        } catch (error) {
            console.error("Erreur Fetch/Réseau :", error);
            
            const loadingDiv = document.getElementById("loading");
            if (loadingDiv) loadingDiv.remove();
            
            messagesDiv.innerHTML +=
                `<div class="message-line error">Erreur de connexion : Impossible de joindre le serveur.</div>`;
        } finally {
            // Réactiver l'input et le bouton
            sendButton.disabled = false;
            input.disabled = false;
            input.focus(); 
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }
    
    // Nouvelle fonction de vérification d'accès
    function checkAdminAccess() {
        const historyOutput = document.getElementById("history-output");
        historyOutput.style.display = 'none';

        const inputCode = prompt("Veuillez entrer le code Administrateur pour voir l'historique.");

        if (inputCode === ADMIN_CODE) {
            getChatHistory();
        } else if (inputCode !== null && inputCode !== "") {
            alert("Code Administrateur incorrect. Accès refusé.");
        }
    }
    
    // Fonction pour récupérer l'historique 
    async function getChatHistory() {
        const historyOutput = document.getElementById("history-output");
        historyOutput.style.display = 'block'; 
        historyOutput.innerHTML = "Chargement de l'historique...";
        
        try {
            // ENVOI DE L'ID UTILISATEUR EN PARAMÈTRE D'URL
            const response = await fetch(`${HISTORY_URL}?userId=${currentUserId}`); 
            const data = await response.json();
            
            if (response.ok && data.history) {
                let formattedHistory = JSON.stringify(data.history, null, 2);
                historyOutput.innerHTML = `<h3>Historique de la Session (UserID: ${currentUserId}):</h3><pre>${formattedHistory}</pre>`;
            } else {
                historyOutput.innerHTML = `Erreur : ${data.history || 'Impossible de charger l\'historique.'}`;
            }
        } catch (error) {
            historyOutput.innerHTML = `Erreur de réseau lors de la récupération de l'historique.`;
            console.error("Error fetching history:", error);
        }
    }
</script>
